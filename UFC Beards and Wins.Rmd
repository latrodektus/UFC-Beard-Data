---
title: "UFC Beards"
output: pdf_document
---
A first Brad-Terry analysis of UFC Beards and wins and losses.

First the libraries that we are using
```{r}
library(BradleyTerry2)
library(dplyr)
library(knitr)
library(ggplot2)
source("functions_for_prepping_bt_analysis.R")
```
Then load the data which comes from Mike.  Note the as.is thing which leaves all the character vectors as strings and does not make them into factors.

```{r}
winner<-read.csv("UFC_winner.csv",as.is=T)
loser<-read.csv("UFC_loser.csv",as.is=T)
predictors<-read.csv("UFC_predictors.csv",as.is=T)
winner<-winner[c(-18,-157),]
loser<-loser[c(-18,-157),]
predictors<-predictors[c(-6,-162),]
predictors$stance[predictors$stance==""]<-"other"
predictors$stance[predictors$stance=="Open Stance "]<-"other"
predictors$stance[predictors$stance=="Switch "]<-"other"
```
Turns out that th weird BradleyTerry thing needs a very specific format to match things up so we label all the unique id columns "ID" and sort the predictor unique ID column to match the order of the levels of the trial-level files

```{r}
names(predictors)[1]<-"ID"
predictors<-arrange(predictors,ID)
row.names(predictors)<-predictors$ID
names(winner)[1]<-"ID"
names(loser)[1]<-"ID"
```

Now stick the winner and loser files together.  This is a bit of a hack to get the levels of the factor to play nice

```{r}
all<-rbind(winner,loser)
```

And add a column to keep the winners and losers labeled

```{r}
all$winning<-c(rep("yes",length(winner$ID)),rep("no",length(winner$ID)))
```

Now turn the unique IDs into a factor.
```{r}
all$ID<-as.factor(all$ID)
```

And split the data.frame into winners and losers.  Now with the levels correct so that all the matching works

```{r}
winner2<-filter(all,winning=="yes")
loser2<-filter(all,winning=="no")
```

Assemble it into a list of data.frames.  This follows the chameleon example from their help thingie.  Probably not strictly necessary.

```{r}
beards<-list(winner=winner2,loser=loser2,predictors=predictors)
```

And at last do the model.  In this framework the [ID] thing is used for individual level covariates

```{r}
model1<-BTm(player1=winner,player2=loser,
            formula = ~ prev + facehair + ht[ID] + reach[ID] +   
            (1|ID), id="ID",data=beards)

summary(model1)
```

And report some summary stuff from the model

```{r}

model2<-BTm(player1=winner,player2=loser,
            formula = ~ prev + as.factor(facehair)  + ht[ID] + reach[ID] + stance[ID] +
            (1|ID), id="ID",data=beards)

summary(model2)
```


Does this result depend on the type of victory? 

2 or less is a TKO or KO

Greater than 3 is submission or decision or some other outcome.  Here we split the dataset into those two categories and show that facial hair still does not have an effect.

```{r}
#other wins including decisions and submissions
w1<-filter(winner,method>=3)
l1<-filter(loser,method>=3)
p1<-subset(predictors,predictors$ID%in%w1$ID)
b.out<-set_up_btm(p1,w1,l1)

model.other.outcomes<-BTm(player1=winner,player2=loser,
            formula = ~  facehair  + reach[ID] + 
            (1|ID), id="ID",data=b.out)
summary(model.other.outcomes)


#TKO's and KO's

w1<-filter(winner,method<=2)
l1<-filter(loser,method<=2)
p1<-subset(predictors,predictors$ID%in%w1$ID)
b.out<-set_up_btm(p1,w1,l1)

model3<-BTm(player1=winner,player2=loser,
            formula = ~  facehair  + reach[ID] + 
            (1|ID), id="ID",data=b.out)
summary(model3)


```

some stuff

```{R}

model.graphics<-BTm(player1=winner,player2=loser,
            formula = ~ prev + facehair  + ht[ID] + reach[ID]  +
            (1|ID), id="ID",data=beards)

summary(model.graphics)
out<-get_bt_abilities(model.graphics,predictors)
predictors$ability<-out$abilities
all<-rbind(winner,loser)
beardy<-summarize(group_by(all,name),mean(facehair))
predictors$beardy<-beardy$`mean(facehair)`[match(predictors$name,beardy$name)]

predictors$beardy[predictors$beardy==1]<-"clean_shaven"
predictors$beardy[predictors$beardy==2]<-"bearded"
predictors$beardy[!predictors$beardy%in%c("clean_shaven","bearded")]<-"variable_or_other"
table(predictors$beardy)

pdf("plot_hist.pdf")
ggplot(predictors,aes(x=ability, fill = beardy)) +
  geom_histogram(binwidth = 0.05)
dev.off()




```


